<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lernâ€‘Pause Tracker (v2) â€“ dynamisch & plattformunabhÃ¤ngig</title>
  <style>
    :root {
      --bg: #0f172a; /* slate-900 */
      --panel: #111827; /* gray-900 */
      --muted: #94a3b8; /* slate-400 */
      --text: #e5e7eb; /* gray-200 */
      --accent: #22c55e; /* green-500 */
      --accent-2: #38bdf8; /* sky-400 */
      --danger: #ef4444; /* red-500 */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 15% 10%, #0b1220 0%, var(--bg) 50%),
                  radial-gradient(1200px 800px at 85% 120%, #0b1220 0%, var(--bg) 60%);
      color: var(--text);
    }
    .container { max-width: 1060px; margin: 0 auto; padding: 24px; }
    header { display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap; }
    .title { font-size: clamp(1.2rem, 2.5vw, 1.8rem); font-weight: 800; letter-spacing: .3px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }
    .grid { display: grid; gap: 16px; }
    @media (min-width: 850px){ .grid-cols-2 { grid-template-columns: 1.3fr 1fr; } }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .timer {
      font-variant-numeric: tabular-nums; font-weight: 800; letter-spacing: 1px;
      font-size: clamp(2.2rem, 6vw, 3.2rem);
    }
    .subtimer { font-variant-numeric: tabular-nums; font-weight: 800; font-size: clamp(1.2rem, 3.5vw, 1.8rem); }
    .hint { color: var(--muted); font-size: .95rem; }
    .btn { cursor: pointer; padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,.08); background: #0b1220; color: var(--text); font-weight: 600; }
    .btn.primary { background: var(--accent); color: #052e16; border-color: rgba(0,0,0,.2); }
    .btn.alt { background: #0b1220; }
    .btn.ghost { background: transparent; }
    .btn.warn { background: var(--danger); color: #2a0f10; border-color: rgba(0,0,0,.2); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .select, .input, .number, .checkbox { background: #0b1220; color: var(--text); border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 10px 12px; }
    table { width: 100%; border-collapse: collapse; font-size: .95rem; }
    th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,.07); text-align: left; }
    th { color: var(--muted); font-weight: 600; }
    .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.1); font-weight: 700; font-variant-numeric: tabular-nums; }
    .pill.accent { border-color: rgba(34,197,94,.35); }
    .muted { color: var(--muted); }
    footer { opacity: .8; font-size: .9rem; margin-top: 18px; }
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding:.1rem .35rem; border:1px solid rgba(255,255,255,.15); border-radius:6px; background:#0b1220;}
    .sep { height: 1px; background: rgba(255,255,255,.08); margin: 12px 0; border-radius: 1px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="title">ðŸ“— Lernâ€‘Pause Tracker v2 Â· Dynamische Formel Â· PWAâ€‘fÃ¤hig</div>
      <div class="hint">Shortcuts: <span class="kbd">Space</span> Start/Pause Â· <span class="kbd">Enter</span> Beenden Â· <span class="kbd">B</span> Break starten/pausieren</div>
    </header>

    <section class="grid grid-cols-2" style="margin-top: 16px;">
      <div class="card">
        <div class="row" style="justify-content: space-between;">
          <div>
            <div class="muted">Lernphase</div>
            <div id="timer" class="timer">00:00:00</div>
          </div>
          <div>
            <div class="muted">Empfohlene Pause</div>
            <div id="suggestedPause" class="pill accent">00:00</div>
          </div>
        </div>

        <div class="row" style="margin-top: 14px;">
          <button id="startBtn" class="btn primary">Start</button>
          <button id="pauseBtn" class="btn alt" disabled>Pausieren</button>
          <button id="resumeBtn" class="btn alt" disabled>Weiter</button>
          <button id="endBtn" class="btn ghost" disabled>Beenden & loggen</button>
          <button id="resetBtn" class="btn warn" disabled>ZurÃ¼cksetzen</button>
        </div>

        <div class="row" style="margin-top: 10px; gap: 18px;">
          <label class="row">Formel:
            <select id="formulaSelect" class="select" style="margin-left: 8px;">
              <option value="decrease">Anreiz fÃ¼r lange Fokussessions (Faktor â†“)</option>
              <option value="increase">MÃ¼digkeitsâ€‘sensitiv (Faktor â†‘)</option>
              <option value="linear">Linear (a + bÂ·t)</option>
            </select>
          </label>
          <label class="row" id="linearControls" style="display:none;">
            a: <input id="aInput" class="number" type="number" step="0.01" value="0.22" style="width:90px;" />
            b: <input id="bInput" class="number" type="number" step="0.001" value="-0.001" style="width:90px;" />
            min: <input id="minInput" class="number" type="number" step="0.01" value="0.18" style="width:90px;" />
            max: <input id="maxInput" class="number" type="number" step="0.01" value="0.26" style="width:90px;" />
          </label>
        </div>
        <p class="hint" style="margin-top: 8px;">
          Vorgaben:
          <strong>Anreiz</strong> â†’ 20â€“40â€¯min: 0,25 Â· 45â€“60â€¯min: 0,22 Â· 75â€“90â€¯min: 0,20.
          <br>
          <strong>MÃ¼digkeitsâ€‘sensitiv</strong> â†’ 20â€“40â€¯min: 0,20 Â· 45â€“60â€¯min: 0,22 Â· 75â€“90â€¯min: 0,25.
          <br>
          <strong>Linear</strong> â†’ f(t) = clamp(min, max, a + bÂ·t[min]).
        </p>

        <div class="sep"></div>

        <div class="row" style="justify-content: space-between; align-items: center;">
          <div>
            <div class="muted">Pausenphase</div>
            <div id="breakTimer" class="subtimer">00:00</div>
          </div>
          <div class="row">
            <button id="breakStartBtn" class="btn alt" disabled>Break starten</button>
            <button id="breakPauseBtn" class="btn alt" disabled>Break pausieren</button>
            <button id="breakEndBtn" class="btn ghost" disabled>Break beenden & loggen</button>
          </div>
        </div>
        <div class="row" style="margin-top: 8px; gap: 16px;">
          <label class="row"><input id="autoLongBreak" type="checkbox" class="checkbox" checked style="margin-right:8px;"> GroÃŸe Pause nach 4 Zyklen (â‰¥30â€“45â€¯min)</label>
          <label class="row"><input id="soundToggle" type="checkbox" class="checkbox" checked style="margin-right:8px;"> Signalton bei Ende</label>
          <label class="row"><input id="wakeToggle" type="checkbox" class="checkbox" checked style="margin-right:8px;"> Bildschirm wach halten</label>
          <label class="row"><input id="notifyToggle" type="checkbox" class="checkbox" checked style="margin-right:8px;"> Desktopâ€‘Benachrichtigung</label>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content: space-between; align-items: baseline;">
          <div style="font-weight: 700;">TagesÃ¼bersicht</div>
          <div class="muted" id="todayLabel"></div>
        </div>
        <div class="row" style="margin-top: 8px; gap: 20px;">
          <div><span class="muted">Lernzeit</span><div id="totalLearn" class="pill">00:00</div></div>
          <div><span class="muted">Pausenzeit</span><div id="totalBreak" class="pill">00:00</div></div>
          <div><span class="muted">Zyklen</span><div id="totalCycles" class="pill">0</div></div>
        </div>
        <div class="row" style="margin-top: 12px;">
          <button id="exportBtn" class="btn alt">Export CSV</button>
          <button id="clearBtn" class="btn ghost">Tageslog lÃ¶schen</button>
          <button id="installBtn" class="btn alt" title="Als App installieren (PWA)" style="display:none;">Installieren</button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top: 16px;">
      <div class="row" style="justify-content: space-between; align-items: baseline;">
        <div style="font-weight: 700;">Protokoll</div>
        <div class="hint">Speicherung lokal (localStorage)</div>
      </div>
      <div style="overflow:auto; max-height: 360px; margin-top: 10px;">
        <table>
          <thead>
            <tr>
              <th>Typ</th>
              <th>Start</th>
              <th>Dauer</th>
              <th>Formel / Faktor</th>
              <th>Empf. Pause</th>
              <th>Notiz</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
    </section>

    <footer>
      Formel: Pausenzeit = Lernzeit Ã— Faktor (dynamisch). V2 mit Breakâ€‘Timer, Langpausenâ€‘Reminder, Benachrichtigungen, Signalton & Wakeâ€‘Lock. Optional PWAâ€‘Installation (Ã¼ber HTTPS/Server).
    </footer>
  </div>

  <script>
    // ===== Utilities =====
    const pad = n => String(n).padStart(2, '0');
    function formatHMS(ms){
      const total = Math.max(0, Math.floor(ms/1000));
      const h = Math.floor(total/3600);
      const m = Math.floor((total%3600)/60);
      const s = total%60;
      return `${pad(h)}:${pad(m)}:${pad(s)}`;
    }
    function formatMM(min){
      const m = Math.round(min);
      const hh = Math.floor(m/60);
      const mm = m % 60;
      return hh>0? `${pad(hh)}:${pad(mm)}` : `${pad(mm)} min`;
    }
    function todayKey(){
      const d = new Date();
      return d.toISOString().slice(0,10);
    }
    function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

    // ===== Storage (per Tag) =====
    function loadLog(){
      const key = 'lp_log_' + todayKey();
      try{ return JSON.parse(localStorage.getItem(key)) || []; }catch{ return []; }
    }
    function saveLog(entries){
      const key = 'lp_log_' + todayKey();
      localStorage.setItem(key, JSON.stringify(entries));
      renderLog();
      updateTotals();
    }

    // ===== Formulae =====
    function factorFor(minutes){
      const mode = document.getElementById('formulaSelect').value;
      if(mode === 'decrease'){
        if(minutes <= 40) return 0.25; // kurze Sessions: mehr Pause
        if(minutes <= 60) return 0.22;
        return 0.20; // 75â€“90+
      }
      if(mode === 'increase'){
        if(minutes <= 40) return 0.20; // kurze Sessions: weniger Pause
        if(minutes <= 60) return 0.22;
        return 0.25; // 75â€“90+
      }
      const a = parseFloat(document.getElementById('aInput').value || '0.22');
      const b = parseFloat(document.getElementById('bInput').value || '-0.001');
      const minF = parseFloat(document.getElementById('minInput').value || '0.18');
      const maxF = parseFloat(document.getElementById('maxInput').value || '0.26');
      return clamp(a + b * minutes, minF, maxF);
    }
    const suggestedBreakMinutes = (minutes)=> minutes * factorFor(minutes);

    // ===== Notification & Sound =====
    async function ensureNotifyPermission(){
      if(!('Notification' in window)) return false;
      if(Notification.permission === 'granted') return true;
      if(Notification.permission !== 'denied'){
        try { const p = await Notification.requestPermission(); return p === 'granted'; } catch { return false; }
      }
      return false;
    }
    function notify(title, body){
      if(!document.getElementById('notifyToggle').checked) return;
      if(!('Notification' in window)) return;
      if(Notification.permission === 'granted') new Notification(title, { body });
    }
    function beep(){
      if(!document.getElementById('soundToggle').checked) return;
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880; // A5
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
        g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime+0.35);
        o.start(); o.stop(ctx.currentTime+0.4);
      }catch{}
    }

    // ===== Screen Wake Lock =====
    let wakeLock = null;
    async function requestWake(){
      if(!document.getElementById('wakeToggle').checked) return;
      if('wakeLock' in navigator){
        try { wakeLock = await navigator.wakeLock.request('screen'); } catch {}
      }
    }
    function releaseWake(){ try { if(wakeLock) { wakeLock.release(); wakeLock = null; } } catch {}
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState === 'visible' && (timerId || breakTimerId)) requestWake(); });

    // ===== PWA (optional; benÃ¶tigt HTTPS/Server) =====
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display = 'inline-block'; });
    document.getElementById('installBtn').addEventListener('click', async ()=>{
      if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; document.getElementById('installBtn').style.display = 'none';
    });
    // Manifest & Service Worker nur registrieren, wenn Ã¼ber http(s) geladen
    if(location.protocol.startsWith('http')){
      try{
        // Dynamisch ein minimalistisches Manifest anhÃ¤ngen
        const manifest = {
          name: 'Lern-Pause Tracker', short_name: 'LPâ€‘Tracker', start_url: '.', display: 'standalone', background_color: '#0f172a', theme_color: '#0f172a', icons: []
        };
        const blob = new Blob([JSON.stringify(manifest)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('link'); link.rel = 'manifest'; link.href = url; document.head.appendChild(link);
      }catch{}
      if('serviceWorker' in navigator){
        try{
          // SW kann nicht von blob:// registriert werden; daher hier eine sehr einfache SW via Data-URL (einige Browser erlauben das nicht). Fallback: ignorieren.
          const swCode = `self.addEventListener('install', e=>{e.waitUntil(caches.open('lp-v1').then(c=>c.addAll(['./'])))}); self.addEventListener('fetch', e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`;
          const swUrl = URL.createObjectURL(new Blob([swCode], {type:'text/javascript'}));
          navigator.serviceWorker.register(swUrl).catch(()=>{});
        }catch{}
      }
    }

    // ===== App State =====
    let startTime = null; // learning
    let elapsedMs = 0;
    let timerId = null;
    let paused = false;

    let breakStart = null;
    let breakElapsedMs = 0;
    let breakTimerId = null;
    let breakPaused = false;
    let breakTargetMin = 0;

    let sessionCount = parseInt(localStorage.getItem('lp_sessions_today_'+todayKey())||'0',10);

    const timerEl = document.getElementById('timer');
    const suggEl = document.getElementById('suggestedPause');
    const breakEl = document.getElementById('breakTimer');

    function tick(){
      const now = Date.now();
      const ms = paused || !timerId ? elapsedMs : (now - startTime) + elapsedMs;
      timerEl.textContent = formatHMS(ms);
      const minutes = ms/60000;
      const breakMin = suggestedBreakMinutes(minutes);
      const f = factorFor(minutes);
      suggEl.textContent = `${Math.round(breakMin)} min (Ã—${f.toFixed(2)})`;
    }

    function breakTick(){
      const now = Date.now();
      const ms = breakPaused || !breakTimerId ? breakElapsedMs : (now - breakStart) + breakElapsedMs;
      const minutes = Math.floor(ms/60000);
      const seconds = Math.floor((ms/1000)%60);
      breakEl.textContent = `${pad(minutes)}:${pad(seconds)}`;
      // Autoâ€‘Signal, wenn Ziel erreicht bzw. Ã¼berschritten
      if(breakTargetMin>0 && minutes >= breakTargetMin){
        notify('Pause erreicht', `Deine Pause von ${breakTargetMin} min ist vorbei.`);
        beep();
        breakTargetMin = 0; // nur einmal benachrichtigen
      }
    }

    function uiState(state){
      const startBtn = document.getElementById('startBtn');
      const pauseBtn = document.getElementById('pauseBtn');
      const resumeBtn = document.getElementById('resumeBtn');
      const endBtn = document.getElementById('endBtn');
      const resetBtn = document.getElementById('resetBtn');
      const bStart = document.getElementById('breakStartBtn');
      const bPause = document.getElementById('breakPauseBtn');
      const bEnd = document.getElementById('breakEndBtn');

      if(state === 'learn_running'){
        startBtn.disabled = true; pauseBtn.disabled = false; resumeBtn.disabled = true; endBtn.disabled = false; resetBtn.disabled = false;
        bStart.disabled = true; bPause.disabled = true; bEnd.disabled = true;
      } else if(state === 'learn_paused'){
        startBtn.disabled = true; pauseBtn.disabled = true; resumeBtn.disabled = false; endBtn.disabled = false; resetBtn.disabled = false;
        bStart.disabled = true; bPause.disabled = true; bEnd.disabled = true;
      } else if(state === 'break_running'){
        startBtn.disabled = true; pauseBtn.disabled = true; resumeBtn.disabled = true; endBtn.disabled = true; resetBtn.disabled = false;
        bStart.disabled = true; bPause.disabled = false; bEnd.disabled = false;
      } else if(state === 'break_paused'){
        startBtn.disabled = true; pauseBtn.disabled = true; resumeBtn.disabled = true; endBtn.disabled = true; resetBtn.disabled = false;
        bStart.disabled = false; bPause.disabled = true; bEnd.disabled = false;
      } else { // idle
        startBtn.disabled = false; pauseBtn.disabled = true; resumeBtn.disabled = true; endBtn.disabled = true; resetBtn.disabled = true;
        bStart.disabled = true; bPause.disabled = true; bEnd.disabled = true;
      }
    }

    // ===== Learning Phase =====
    function start(){
      if(timerId) return;
      ensureNotifyPermission();
      requestWake();
      startTime = Date.now(); elapsedMs = 0; paused = false;
      timerId = setInterval(tick, 250);
      uiState('learn_running');
      tick();
    }
    function pause(){
      if(!timerId || paused) return;
      paused = true;
      elapsedMs = (Date.now() - startTime) + elapsedMs;
      uiState('learn_paused');
      tick();
    }
    function resume(){
      if(!timerId || !paused) return;
      paused = false; startTime = Date.now();
      uiState('learn_running');
    }
    function endSession(){
      if(!timerId) return;
      const totalMs = paused ? elapsedMs : (Date.now() - startTime) + elapsedMs;
      clearInterval(timerId); timerId = null;
      const minutes = Math.max(1, Math.round(totalMs/60000));
      const factor = factorFor(minutes);
      const breakMin = Math.round(suggestedBreakMinutes(minutes));
      addLogEntry({ type: 'learn', ts: new Date().toISOString(), minutes, factor, breakMin, note: '' });

      sessionCount += 1; localStorage.setItem('lp_sessions_today_'+todayKey(), String(sessionCount));

      // Reset learn timer
      startTime = null; elapsedMs = 0; paused = false; timerEl.textContent = '00:00:00'; suggEl.textContent = '00:00';

      // Autoâ€‘Breakâ€‘Ziel berechnen
      let target = breakMin;
      const wantLong = document.getElementById('autoLongBreak').checked;
      if(wantLong && sessionCount % 4 === 0){ target = Math.max(target, 30); }
      startBreak(target);
    }

    function resetTimer(){
      if(timerId){ clearInterval(timerId); timerId = null; }
      startTime = null; elapsedMs = 0; paused = false;
      timerEl.textContent = '00:00:00'; suggEl.textContent = '00:00';
      uiState('idle');
      releaseWake();
    }

    // ===== Break Phase =====
    function startBreak(targetMin=0){
      breakTargetMin = Math.max(0, Math.round(targetMin));
      breakStart = Date.now(); breakElapsedMs = 0; breakPaused = false;
      if(breakTimerId) clearInterval(breakTimerId);
      breakTimerId = setInterval(breakTick, 250);
      uiState('break_running');
      breakTick();
      notify('Pause gestartet', breakTargetMin>0? `Ziel: ${breakTargetMin} min` : 'Ohne Ziel');
      requestWake();
    }
    function pauseBreak(){
      if(!breakTimerId || breakPaused) return;
      breakPaused = true;
      breakElapsedMs = (Date.now() - breakStart) + breakElapsedMs;
      uiState('break_paused');
      breakTick();
    }
    function resumeBreak(){
      if(!breakTimerId || !breakPaused) return;
      breakPaused = false; breakStart = Date.now();
      uiState('break_running');
    }
    function endBreak(){
      if(!breakTimerId) return;
      const totalMs = breakPaused ? breakElapsedMs : (Date.now() - breakStart) + breakElapsedMs;
      clearInterval(breakTimerId); breakTimerId = null;
      const minutes = Math.max(1, Math.round(totalMs/60000));
      addLogEntry({ type: 'break', ts: new Date().toISOString(), minutes, factor: null, breakMin: null, note: '' });

      // Reset break timer
      breakStart = null; breakElapsedMs = 0; breakPaused = false; breakEl.textContent = '00:00'; breakTargetMin = 0;
      uiState('idle');
      notify('Pause beendet', `${minutes} min`);
      beep();
      releaseWake();
    }

    // ===== Log =====
    function addLogEntry(entry){ const entries = loadLog(); entries.unshift(entry); saveLog(entries); }
    function deleteEntry(idx){ const entries = loadLog(); entries.splice(idx,1); saveLog(entries); }
    function updateNote(idx, value){ const entries = loadLog(); entries[idx].note = value; saveLog(entries); }

    function renderLog(){
      const body = document.getElementById('logBody');
      const entries = loadLog();
      body.innerHTML = '';
      entries.forEach((e, i) => {
        const tr = document.createElement('tr');
        const start = new Date(e.ts);
        tr.innerHTML = `
          <td>${e.type||'learn'}</td>
          <td>${start.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</td>
          <td>${e.minutes} min</td>
          <td>${e.type==='learn' ? (e.factor!=null? (e.factor).toFixed(2) : '') : ''}</td>
          <td>${e.type==='learn' ? (e.breakMin!=null? e.breakMin + ' min' : '') : ''}</td>
          <td><input class="input" placeholder="Notiz" value="${e.note||''}" style="width: 100%;"></td>
          <td><button class="btn ghost" data-del>âœ•</button></td>
        `;
        tr.querySelector('input').addEventListener('input', (ev)=> updateNote(i, ev.target.value));
        tr.querySelector('[data-del]').addEventListener('click', ()=> deleteEntry(i));
        body.appendChild(tr);
      });
    }

    function updateTotals(){
      const entries = loadLog();
      const learn = entries.filter(e=>e.type==='learn').reduce((s,e)=> s+e.minutes, 0);
      const brk = entries.filter(e=>e.type==='break').reduce((s,e)=> s+e.minutes, 0);
      document.getElementById('totalLearn').textContent = formatMM(learn);
      document.getElementById('totalBreak').textContent = formatMM(brk);
      document.getElementById('totalCycles').textContent = String(entries.filter(e=>e.type==='learn').length);
      document.getElementById('todayLabel').textContent = new Date().toLocaleDateString(undefined, {weekday:'long', year:'numeric', month:'2-digit', day:'2-digit'});
    }

    function exportCSV(){
      const entries = loadLog();
      const header = 'date,start_time,type,minutes,factor,break_recommendation,note
';
      const rows = entries.map(e => {
        const d = new Date(e.ts);
        const date = d.toISOString().slice(0,10);
        const time = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        return [date, time, e.type||'learn', e.minutes, e.factor!=null? e.factor.toFixed(2):'', e.breakMin!=null? e.breakMin:'', (e.note||'').replace(/
/g,' ')].join(',');
      }).join('
');
      const blob = new Blob([header + rows], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `lern_pause_${todayKey()}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    function clearDay(){
      if(!confirm('Tageslog wirklich lÃ¶schen?')) return;
      localStorage.removeItem('lp_log_' + todayKey());
      localStorage.removeItem('lp_sessions_today_'+todayKey());
      sessionCount = 0;
      renderLog(); updateTotals();
    }

    // ===== Events =====
    document.getElementById('startBtn').addEventListener('click', start);
    document.getElementById('pauseBtn').addEventListener('click', pause);
    document.getElementById('resumeBtn').addEventListener('click', resume);
    document.getElementById('endBtn').addEventListener('click', endSession);
    document.getElementById('resetBtn').addEventListener('click', resetTimer);

    document.getElementById('breakStartBtn').addEventListener('click', ()=> startBreak());
    document.getElementById('breakPauseBtn').addEventListener('click', pauseBreak);
    document.getElementById('breakEndBtn').addEventListener('click', endBreak);

    document.getElementById('exportBtn').addEventListener('click', exportCSV);
    document.getElementById('clearBtn').addEventListener('click', clearDay);

    document.getElementById('formulaSelect').addEventListener('change', (e)=>{
      const isLinear = e.target.value === 'linear';
      document.getElementById('linearControls').style.display = isLinear ? 'flex' : 'none';
      tick();
    });
    ['aInput','bInput','minInput','maxInput'].forEach(id=> document.getElementById(id).addEventListener('input', tick));

    // Keyboard shortcuts
    window.addEventListener('keydown', (ev)=>{
      if(ev.code === 'Space'){ ev.preventDefault(); if(!timerId && !breakTimerId) start(); else if(timerId && !paused) pause(); else if(timerId && paused) resume(); else if(breakTimerId && !breakPaused) pauseBreak(); else if(breakTimerId && breakPaused) resumeBreak(); }
      if(ev.code === 'Enter'){ if(timerId) endSession(); if(breakTimerId) endBreak(); }
      if(ev.key.toLowerCase() === 'b'){ if(!breakTimerId) startBreak(); else if(!breakPaused) pauseBreak(); else resumeBreak(); }
    });

    // ===== Init =====
    renderLog(); updateTotals(); uiState('idle'); tick(); breakTick();
  </script>
</body>
</html>
